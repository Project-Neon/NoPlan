<!DOCTYPE html>
<html>
<head>
	<script src="/socket.io/socket.io.js"></script>	
	<title>No Plan | Project Neon</title>
	<style type="text/css">
		body{
  		background-color: #333;
		}
		.panel{
			background-color: white;
			width: 200px; 
			float: left;
			padding: 20px;
			margin: 20px;
			border: 12px;
		}
		.start {
			background-color: #5d5d5d;
	    border: none;
	    color: white;
	    padding: 15px 32px;
	    text-align: center;
	    text-decoration: none;		
	    display: inline-block;
	    font-size: 16px;
	    width: 180px;
	    margin: 10px;
		}.side {
	    background-color: #0000FF; /* Blue */
	    border: none;
	    color: white;
	    padding: 15px 32px;
	    text-align: center;
	    text-decoration: none;
	    display: inline-block;
	    font-size: 16px;
	    width: 180px;
	    margin: 10px;
		}
		.field{
			float: left;
		}

	</style>
</head>
	<body>
		<div class="main">
			<div class="panel">
				<div class="title">
					<h1 style="font-family:Verdana; text-align: center;">NoPlan</h1>
				</div>
				<div class="buttons" align="center">
						<button class="start" id="match" onclick="changeState()">Toggle Game</button>
						<button class="side" id="side" onclick="changeSide()">Change Side</button>
				</div>
			</div>
			<div class="field" style="max-width: 100%;">
				<canvas id="field_canvas" width="1200" style="width:75%;align-items: center;"></canvas>
			</div>
		</div>



		<script type="text/javascript">
			
			var socket = io.connect('http://localhost')
			let matchState = false
			let matchSide = false
			function changeState() {
				matchState ? document.getElementById('match').style.backgroundColor = "#FF0000" : document.getElementById('match').style.backgroundColor = "#4CAF50"
				socket.emit('state', {state:"toggle"})
				matchState = !matchState
			}
			
			function changeSide() {
				matchSide ? document.getElementById('side').style.backgroundColor = "#0000FF" : document.getElementById('side').style.backgroundColor = "#FFFF00"

				socket.emit('state', {state:"side"})
				matchSide = !matchSide
			}

			var canvas = document.getElementById("field_canvas");
			var ctx = canvas.getContext("2d");
			
			var canvasH = 1300;
			var canvasW = 1700;

			var width = canvas.width;
			var scale = width / canvasW;
			var height = scale * canvasH;
			canvas.height = height;

			var xCenter = width / 2;
			var yCenter = height / 2;

			window.onload = function () {



					socket.on('detection', function(msg){
						//var drawStart = Date.now()
						detection_json = msg
						drawField(ctx, canvas.width, canvas.height);
						// start ball drawing
						// end ball drawing

						// start player drawing
						detection_json.robots_blue.forEach(function(robot) {
							player_pos = translatePosition(robot.x, robot.y)
							tag = robot.robot_id
							angle = robot.orientation
							confidence = robot.confidence
							drawPlayer(ctx, player_pos.x, player_pos.y, -angle, 'blue', tag, confidence)
						});

						detection_json.robots_yellow.forEach(function(robot) {
							player_pos = translatePosition(robot.x, robot.y)
							tag = robot.robot_id
							angle = robot.orientation
							confidence = robot.confidence
							drawPlayer(ctx, player_pos.x, player_pos.y, -angle, 'yellow', tag, confidence)
						});
						// end player drawing
						//console.log(Date.now()-drawStart)
						if(detection_json.balls.length >= 1) {
							ball_pos = [
								detection_json.balls[0].x,
								detection_json.balls[0].y
							]
							ball_pos = translatePosition(ball_pos[0], ball_pos[1])
							drawBall(ctx, ball_pos.x, ball_pos.y, 12, 'orange')
						}
					});
				}
			

			function drawField(ctx, w, h) {
				// Render field
				ctx.fillStyle = "#333";
				ctx.fillRect(0, 0, width, height);

				// Draw Field center lines and circle
				ctx.beginPath();
				ctx.fillStyle = "#FFF";
				ctx.arc(xCenter, yCenter, 1, 0, Math.PI * 2, false);
				ctx.fill();
				var widthP = w;
				var heightP = h;

				var widthCm = 170;
				var heightCm = 130;

				var ratioPxCm = widthP/widthCm;

				var xCenter = widthP / 2;
				var yCenter = heightP / 2;

				var goalH=40*ratioPxCm;


				ctx.beginPath();
				ctx.strokeStyle="white";
				ctx.lineWidth=0.5*ratioPxCm;
				ctx.rect(xCenter-(75*ratioPxCm),0,150*ratioPxCm,130*ratioPxCm);
				ctx.stroke();

				ctx.beginPath();
				ctx.arc(xCenter,yCenter,(20*ratioPxCm),0,2*Math.PI);
				ctx.stroke();


				//Left Goal Area
				ctx.beginPath();
				ctx.strokeStyle="white";
				ctx.lineWidth=0.5*ratioPxCm;
				ctx.fillStyle='#444'
				ctx.fillRect(0,yCenter-(20*ratioPxCm),10.3*ratioPxCm,40*ratioPxCm);
				ctx.stroke();

				//Right Goal Area
				ctx.beginPath();
				ctx.strokeStyle="white";
				ctx.lineWidth=0.5*ratioPxCm;
				ctx.fillStyle='#444'
				ctx.fillRect(widthP-(10.3*ratioPxCm),yCenter-(20*ratioPxCm),10*ratioPxCm,40*ratioPxCm);
				ctx.stroke();

				//Draw Left Goal Lines
				ctx.beginPath();
				ctx.strokeStyle="white";
				ctx.lineWidth=0.5*ratioPxCm;
				ctx.fillStyle='#333'
				ctx.moveTo(xCenter+(170*ratioPxCm),yCenter+(20*ratioPxCm));
				ctx.lineTo(xCenter+(170*ratioPxCm)-(10*ratioPxCm),yCenter+(20*ratioPxCm));
				ctx.lineTo(xCenter+(170*ratioPxCm)-(10*ratioPxCm),yCenter+(20*ratioPxCm));
				ctx.lineTo(xCenter+(170*ratioPxCm),(yCenter+(35*ratioPxCm))-(70*ratioPxCm));

				// Draw Central Line'
				ctx.moveTo(xCenter,0);
				ctx.lineTo(xCenter,heightP);

				//Draw Right side goal area
				ctx.moveTo(xCenter+(75*ratioPxCm),yCenter+(35*ratioPxCm));
				ctx.lineTo(xCenter+(60*ratioPxCm),yCenter+(35*ratioPxCm));
				ctx.lineTo(xCenter+(60*ratioPxCm),(yCenter+(35*ratioPxCm))-(70*ratioPxCm));
				ctx.lineTo(xCenter+(75*ratioPxCm),(yCenter+(35*ratioPxCm))-(70*ratioPxCm));

				//Draw Left side goal area
				ctx.moveTo(xCenter-(75*ratioPxCm),yCenter+(35*ratioPxCm));
				ctx.lineTo(xCenter-(60*ratioPxCm),yCenter+(35*ratioPxCm));
				ctx.lineTo(xCenter-(60*ratioPxCm),(yCenter+(35*ratioPxCm))-(70*ratioPxCm));
				ctx.lineTo(xCenter-(75*ratioPxCm),(yCenter+(35*ratioPxCm))-(70*ratioPxCm));


				//Draw bottom-left +
				ctx.moveTo(xCenter-(37.5*ratioPxCm),(yCenter)+(44*ratioPxCm));
				ctx.lineTo(xCenter-(37.5*ratioPxCm),(yCenter)+(36*ratioPxCm));
				ctx.moveTo(xCenter-(41.5*ratioPxCm),(yCenter)+(40*ratioPxCm));
				ctx.lineTo(xCenter-(33.5*ratioPxCm),(yCenter)+(40*ratioPxCm));
				//Draw center-left +
				ctx.moveTo((xCenter)-37.5*ratioPxCm,(yCenter)-(4*ratioPxCm));
				ctx.lineTo((xCenter)-37.5*ratioPxCm,(yCenter)+(4*ratioPxCm));
				ctx.moveTo((xCenter)-41.5*ratioPxCm,yCenter);
				ctx.lineTo((xCenter)-33.5*ratioPxCm,yCenter);
				//Draw top-left +
				ctx.moveTo((xCenter)-37.5*ratioPxCm,(yCenter)-(44*ratioPxCm));
				ctx.lineTo((xCenter)-37.5*ratioPxCm,(yCenter)-(36*ratioPxCm));
				ctx.moveTo((xCenter)-41.5*ratioPxCm,(yCenter)-(40*ratioPxCm));
				ctx.lineTo((xCenter)-33.5*ratioPxCm,(yCenter)-(40*ratioPxCm));


				//Draw bottom-right +
				ctx.moveTo(xCenter+(37.5*ratioPxCm),(yCenter)+(44*ratioPxCm));
				ctx.lineTo(xCenter+(37.5*ratioPxCm),(yCenter)+(36*ratioPxCm));
				ctx.moveTo(xCenter+(41.5*ratioPxCm),(yCenter)+(40*ratioPxCm));
				ctx.lineTo(xCenter+(33.5*ratioPxCm),(yCenter)+(40*ratioPxCm));
				//Draw center-right +
				ctx.moveTo((xCenter)+37.5*ratioPxCm,(yCenter)-(4*ratioPxCm));
				ctx.lineTo((xCenter)+37.5*ratioPxCm,(yCenter)+(4*ratioPxCm));
				ctx.moveTo((xCenter)+41.5*ratioPxCm,yCenter);
				ctx.lineTo((xCenter)+33.5*ratioPxCm,yCenter);
				//Draw top-right +
				ctx.moveTo((xCenter)+37.5*ratioPxCm,(yCenter)-(44*ratioPxCm));
				ctx.lineTo((xCenter)+37.5*ratioPxCm,(yCenter)-(36*ratioPxCm));
				ctx.moveTo((xCenter)+41.5*ratioPxCm,(yCenter)-(40*ratioPxCm));
				ctx.lineTo((xCenter)+33.5*ratioPxCm,(yCenter)-(40*ratioPxCm));

				ctx.strokeStyle="white";
				ctx.lineWidth=0.5*ratioPxCm;
				ctx.stroke();
			}

			function translatePosition(pos_x, pos_y) {
				x = pos_x * scale + width/2
				y = pos_y * scale + height/2
				return {'x': x, 'y': height - y}
			}

			function drawBall(ctx, pos_x, pos_y, radius, color) {
				ctx.beginPath();
				ctx.fillStyle = color;
				ctx.strokeStyle = 'orange';
				ctx.arc(pos_x,pos_y,radius, 0, 2*Math.PI);
				ctx.fill();
				ctx.stroke();
			}

			function drawSemiCircle(ctx, pos_x, pos_y, init_angle, end_angle, radius, color) {
				ctx.beginPath();
				ctx.strokeStyle = color;
				ctx.arc(pos_x, pos_y, 30, init_angle, end_angle);
				ctx.stroke();
			}

			function drawPlayer(ctx, pos_x, pos_y, angle, color, number_tag, confidence) {
				ctx.beginPath();
				ctx.fillStyle = 'gray';
				ctx.fillRect(pos_x-40, pos_y-50, 80, 15)
				ctx.fillStyle = color
				ctx.fillRect(pos_x-40, pos_y-50, 80 * confidence, 15)
				ctx.lineWidth = 7;
				ctx.strokeStyle = 'black';
				ctx.stroke();
				drawSemiCircle(ctx, pos_x, pos_y, angle + 0.75, angle - 0.75, 'red')
				ctx.fill();
				ctx.font = "30px Verdana";
				ctx.fillStyle = 'black';
				ctx.fillText(number_tag, pos_x-9, pos_y+10);
			}
		</script>
	</body>
</html>